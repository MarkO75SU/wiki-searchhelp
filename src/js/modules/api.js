// src/js/modules/api.js

/**
 * Parses the generated search query to separate recognized parameters from the main search term.
 * @param {string} query - The full search query string generated by the user.
 * @returns {object} An object containing parsed parameters.
 */
function parseAdvancedSearchParams(query) {
    const params = {
        srsearch: query,
        srincategory: '',
        deepcategory: '',
        srhastemplate: '',
        srprefix: '',
        srincontent: '', // Corresponds to insource
        srfiletype: ''
    };

    let currentQuery = query; // Use a distinct variable to track the evolving query string

    const definitions = {
        srincategory: { regex: /incategory:("([^"]*?)"|([^\s]+))/gi, separator: '|' }, // Global regex
        deepcategory: { regex: /deepcat:("([^"]*?)"|([^\s]+))/gi },
        srhastemplate: { regex: /hastemplate:("([^"]*?)"|([^\s]+))/gi },
        srprefix: { regex: /prefix:("([^"]*?)"|([^\s]+))/gi },
        srincontent: { regex: /insource:("([^"]*?)"|([^\s]+))/gi },
        srfiletype: { regex: /filetype:("([^"]*?)"|([^\s]+))/gi }
    };

    for (const paramKey in definitions) {
        const { regex, separator } = definitions[paramKey];
        let values = [];

        // Find all matches for the current parameter type
        const matches = [...currentQuery.matchAll(regex)]; // Get all matches

        matches.forEach(match => {
            const value = match[2] || match[3]; // Quoted or unquoted value
            if (value) {
                values.push(value);
            }
        });

        if (values.length > 0) {
            params[paramKey] = values.join(separator || ' '); // Join with separator or space
        }

        // Remove ALL occurrences of this parameter from the query string
        currentQuery = currentQuery.replace(regex, '').trim();
    }

    params.srsearch = currentQuery.trim(); // The remainder is the core search string

    return params;
}

/**
 * Performs a search on the Wikipedia API.
 * @param {string} query - The search query string.
 * @param {string} lang - The language of the Wikipedia to search.
 * @returns {Promise<object>} A promise that resolves to the full API response object.
 */
export async function performWikipediaSearch(query, lang = 'de', limit = 10) {
    // Basic search call to get list of results
    const url = `https://${lang}.wikipedia.org/w/api.php?action=query&format=json&origin=*&list=search&srsearch=${encodeURIComponent(query)}&srlimit=${limit}&prop=pageimages&piprop=thumbnail&pithumbsize=150`;
    
    try {
        const response = await fetch(url);
        return await response.json();
    } catch (error) {
        console.error("Wikipedia search error:", error);
        return null;
    }
}

/**
 * Fetches additional info (like images) for specific titles.
 */
export async function fetchArticlesInfo(titles, lang = 'de') {
    const url = `https://${lang}.wikipedia.org/w/api.php?action=query&format=json&origin=*&titles=${encodeURIComponent(titles.join('|'))}&prop=pageimages&piprop=thumbnail&pithumbsize=150`;
    try {
        const response = await fetch(url);
        return await response.json();
    } catch (error) {
        console.error("Wikipedia info error:", error);
        return null;
    }
}

/**
 * Fetches a brief summary for a given article title.
 * @param {string} title - The title of the article.
 * @param {string} lang - The language of the Wikipedia.
 * @returns {Promise<string>} A promise that resolves to the article summary.
 */
export async function fetchArticleSummary(title, lang) {
    const endpoint = `https://${lang}.wikipedia.org/w/api.php`;
    const params = new URLSearchParams({
        action: 'query',
        prop: 'extracts',
        exintro: true,
        explaintext: true,
        titles: title,
        format: 'json',
        origin: '*'
    });
    const url = `${endpoint}?${params}`;

    try {
        const response = await fetch(url);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        const pages = data.query.pages;
        const pageId = Object.keys(pages)[0];
        if (pageId === "-1" || !pages[pageId].extract) {
            return "No summary available.";
        }
        return pages[pageId].extract;
    } catch (error) {
        console.error(`Could not fetch summary for ${title}:`, error);
        return "Summary could not be retrieved.";
    }
}
